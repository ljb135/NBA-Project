<div class="container2">
  {% with messages = get_flashed_messages(category_filter=["error"]) %}
    {% if messages %}
      {% for message in messages %}
        {{ message }}
      {% endfor %}
    {% endif %}
  {% endwith %}
</div>

{%  extends "layout.html" %}
{% block content %}

<div class = "subheading">
  <h2>
    Enter the names and years of the players on both teams.
    <br>
    9 players for each team are required - you may enter up to 13.
  </h2>
</div>

<form method="POST" action="">

  {{ form.hidden_tag() }}

  <div class="form">
    <div class="column">
      <h3><u><b>Home Team</b></u></h3>
      <div class = "partialform">
        {% for player in form.home_players %}
        <h3><b>{{ loop.index }}.</b> {{ player.year }} {{ player.player_name }}</h3>
        {% endfor %}
      </div>
    </div>

    <div class="column">
      <h3><u><b>Away Team</b></u></h3>
      <div class = "partialform">
        {% for player in form.away_players %}
        <h3><b>{{ loop.index }}.</b> {{ player.year }} {{ player.player_name }}</h3>
        {% endfor %}
      </div>
    </div>

    <div class = "row">
      {{ form.submit }}
    </div>

    {% if form.errors %}
      {{form.errors}}
    {% endif %}
  </div>

</form>

{% with messages = get_flashed_messages(category_filter=["success"]) %}
  {% if messages %}
    {% for message in messages %}
      <h5>{{ message }} </h5>
    {% endfor %}
  {% endif %}
{% endwith %}

<script>
  function playerlist_update(year_field, name_field){
    let year_select = document.getElementById(year_field);
    let name_select = document.getElementById(name_field);

    year_select.onchange = function(){
      year = year_select.value;
      sessionStorage.setItem(year_field, year);
      fetch("/update/" + year).then(function(response){
        response.json().then(function(data){
          let optionHTML = '';
          for(let player of data.players){
            optionHTML += "<option value=" + player.player_id.toString() + ">" + player.name.toString() + "</option>";
          }
          name_select.innerHTML = optionHTML;
        });
      });
    }
    name_select.onchange = function(){
      name = name_select.value;
      sessionStorage.setItem(name_field, name);
    }

    window.addEventListener("load", function() {
      if (sessionStorage[year_field]){
        year_select.innerHTML = sessionStorage.getItem(year_field);
      }
      if (sessionStorage[name_field]){
        name_select.innerHTML = sessionStorage.getItem(name_field);
      }
    }, false);
  }

  var i;
  for ( i = 0; i < 13; i++ ){
    year = "home_players-" + i + "-year"
    name = "home_players-" + i + "-player_name"
    playerlist_update(year, name)
  }
  for ( i = 0; i < 13; i++ ){
    year = "away_players-" + i + "-year"
    name = "away_players-" + i + "-player_name"
    playerlist_update(year, name)
  }
</script>

{% endblock content %}